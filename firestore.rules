rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction helper pour vérifier si l'utilisateur est authentifié
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Fonction helper pour vérifier si l'utilisateur est le propriétaire du document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Fonction helper pour récupérer le rôle de l'utilisateur
    function getUserRole() {
      return get(/databases/$(database)/documents/clients/$(request.auth.uid)).data.role;
    }
    
    // Fonction helper pour vérifier si l'utilisateur est admin
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    // Fonction helper pour vérifier si l'utilisateur est coach
    function isCoach() {
      return isSignedIn() && getUserRole() == 'coach';
    }
    
    // Fonction helper pour vérifier si l'utilisateur est admin ou coach
    function isAdminOrCoach() {
      return isAdmin() || isCoach();
    }
    
    // Fonction helper pour vérifier si un coach a accès à un client
    function coachHasAccessToClient(clientId) {
      return isCoach() && get(/databases/$(database)/documents/clients/$(clientId)).data.coachId == request.auth.uid;
    }
    
    // Collection clients
    match /clients/{clientId} {
      // Lecture : 
      // - Admin : tous les clients
      // - Coach : ses propres clients + son propre profil
      // - Client : uniquement son propre profil
      allow read: if isAdmin() 
                  || isOwner(clientId) 
                  || coachHasAccessToClient(clientId);
      
      // Création : 
      // - Admin : tous les clients
      // - Inscription publique : uniquement son propre profil lors de l'inscription
      allow create: if isAdmin() 
                    || (isSignedIn() && request.auth.uid == clientId);
      
      // Mise à jour :
      // - Admin : tous les clients
      // - Coach : ses propres clients (mais pas leur rôle ou coachId)
      // - Client : uniquement son propre profil (mais pas son rôle ou coachId)
      allow update: if isAdmin() 
                    || (isOwner(clientId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'coachId']))
                    || (coachHasAccessToClient(clientId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'coachId']));
      
      // Suppression : uniquement admin
      allow delete: if isAdmin();
    }
    
    // Collection exercises
    match /exercises/{exerciseId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Collection programs
    match /programs/{programId} {
      // Lecture : 
      // - Admin : tous
      // - Coach : ses propres programmes
      // - Client : programmes qui lui sont assignés
      allow read: if isAdmin() 
                  || (isCoach() && resource.data.coachId == request.auth.uid)
                  || (isSignedIn() && resource.data.clientId == request.auth.uid);
      
      // Création/Modification : admin et coach
      allow create, update: if isAdminOrCoach();
      
      // Suppression : admin et coach propriétaire
      allow delete: if isAdmin() || (isCoach() && resource.data.coachId == request.auth.uid);
    }
    
    // Collection sessions
    match /sessions/{sessionId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Collection nutritionPlans
    match /nutritionPlans/{planId} {
      // Lecture :
      // - Admin : tous
      // - Coach : ses propres plans
      // - Client : plans qui lui sont assignés
      allow read: if isAdmin() 
                  || (isCoach() && resource.data.coachId == request.auth.uid)
                  || (isSignedIn() && resource.data.clientId == request.auth.uid);
      
      // Création/Modification : admin et coach
      allow create, update: if isAdminOrCoach();
      
      // Suppression : admin et coach propriétaire
      allow delete: if isAdmin() || (isCoach() && resource.data.coachId == request.auth.uid);
    }
    
    // Collection messages
    match /messages/{messageId} {
      // Lecture : 
      // - Admin : tous
      // - Coach : messages de ses clients
      // - Client : ses propres messages
      allow read: if isAdmin() 
                  || (isSignedIn() && (resource.data.senderId == request.auth.uid || resource.data.clientId == request.auth.uid));
      
      // Création : expéditeur doit être l'utilisateur authentifié
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      
      // Mise à jour : pour marquer comme lu
      allow update: if isSignedIn() && (resource.data.senderId == request.auth.uid || resource.data.clientId == request.auth.uid);
      
      // Suppression : admin uniquement
      allow delete: if isAdmin();
    }
    
    // Collection clientFormations
    match /clientFormations/{formationId} {
      // Lecture : 
      // - Admin : toutes
      // - Coach : ses propres formations
      // - Client : formations auxquelles il a accès (via grantedFormationIds)
      allow read: if isAdmin() 
                  || (isCoach() && resource.data.coachId == request.auth.uid)
                  || (isSignedIn() && get(/databases/$(database)/documents/clients/$(request.auth.uid)).data.grantedFormationIds.hasAny([formationId]));
      
      // Création/Modification/Suppression : admin et coach propriétaire
      allow create, update, delete: if isAdmin() || (isCoach() && request.resource.data.coachId == request.auth.uid);
    }
    
    // Collection professionalFormations
    match /professionalFormations/{formationId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin uniquement
      allow create, update, delete: if isAdmin();
    }
    
    // Collection notifications
    match /notifications/{notificationId} {
      // Lecture : utilisateur concerné uniquement
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Création : admin et coach
      allow create: if isAdminOrCoach();
      
      // Mise à jour : utilisateur concerné (pour marquer comme lu)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Suppression : admin uniquement
      allow delete: if isAdmin();
    }
    
    // Collection foodItems
    match /foodItems/{foodItemId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Collection bilanTemplates
    match /bilanTemplates/{templateId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Collection partners
    match /partners/{partnerId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et propriétaire
      allow create, update, delete: if isAdmin() || (isCoach() && resource.data.ownerId == request.auth.uid);
    }
    
    // Collection products
    match /products/{productId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et propriétaire
      allow create, update, delete: if isAdmin() || (isCoach() && resource.data.ownerId == request.auth.uid);
    }
    
    // Collection intensificationTechniques
    match /intensificationTechniques/{techniqueId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin uniquement
      allow create, update, delete: if isAdmin();
    }
    
    // Collection recipes
    match /recipes/{recipeId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Collection meals
    match /meals/{mealId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if isSignedIn();
      
      // Création/Modification/Suppression : admin et coach
      allow create, update, delete: if isAdminOrCoach();
    }
    
    // Règle par défaut : tout refuser
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
